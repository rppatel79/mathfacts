<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Math Practice</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #question-container { margin-top: 20px; }
        #scoreboard { margin-top: 10px; }
    </style>
</head>
<body>
<h1>Math Practice</h1>

<select id="level" disabled>
    <option value="BEGINNER">Level 1</option>
    <option value="INTERMEDIATE">Level 2</option>
    <option value="ADVANCED">Level 3</option>
</select>

<div id="question-container">
    <p id="question"></p>
    <input type="number" id="answer" placeholder="Your answer">
    <button id="submit-btn" onclick="submitAnswer()" disabled>Submit</button>
</div>

<div id="scoreboard">
    <p id="result"></p>
    <p id="score">Score: 0 / 0</p>
    <p id="streak">Streak: 0</p>
    <p id="timer">‚è±Ô∏è Time: 0s</p>
    <button id="clear-score-btn" onclick="clearScore()" disabled>Clear Score</button>
</div>

<!-- Sound effects -->
<audio id="success-sound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3" preload="auto"></audio>
<audio id="incorrect-sound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
<audio id="levelup-sound" src="https://www.soundjay.com/misc/sounds/button-2.mp3" preload="auto"></audio>

<script>
    const levelSelect = document.getElementById('level');
    const levelOrder = ["BEGINNER", "INTERMEDIATE", "ADVANCED"];

    let currentQuestion = {};
    let total = 0, correct = 0, incorrect = 0, streak = 0, timer = 0;
    let timerInterval;
    let currentTestType = null;
    let currentLevelEnum = null;
    let testTypeMap = {};

    const correctSound = document.getElementById('success-sound');
    const incorrectSound = document.getElementById('incorrect-sound');
    const levelUpSound = document.getElementById('levelup-sound');
    const submitBtn = document.getElementById('submit-btn');
    const clearScoreBtn = document.getElementById('clear-score-btn');
    const answerInput = document.getElementById('answer');

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');

    async function updateStudentSession() {
        const payload = {
            session: {
                testType: currentTestType,
                level: currentLevelEnum,
                correctStreak: streak,
                incorrectStreak: incorrect,
                currentQuestion: currentQuestion
            }
        };

        await fetch(`/students/${studentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    }

    async function loadStudent() {
        if (!studentId) {
            alert("Missing student ID. Please go back and select a student.");
            return;
        }

        try {
            const res = await fetch(`/students/${studentId}`);
            if (!res.ok) throw new Error("Student not found");

            const student = await res.json();
            document.querySelector('h1').innerText = `Math Practice ‚Äì ${student.name}`;

            testTypeMap = student.testTypeToLevel;
            const testTypes = Object.keys(testTypeMap);
            if (testTypes.length === 0) {
                alert("Student has no test types assigned.");
                return;
            }

            currentTestType = testTypes[0];
            currentLevelEnum = testTypeMap[currentTestType];

            levelSelect.value = currentLevelEnum;

            await getQuestion(); // Load the first question

        } catch (error) {
            alert("Error loading student: " + error.message);
        }
    }

    async function getQuestion() {
        const res = await fetch(`/api/math/question?level=${currentLevelEnum}&testType=${currentTestType}`);
        const data = await res.json();

        currentQuestion = {
            a: data.a,
            b: data.b,
            testType: currentTestType
        };

        document.getElementById('question').innerText = `What is ${data.question}?`;
        document.getElementById('result').innerText = '';
        answerInput.value = '';
        answerInput.disabled = false;
        answerInput.focus();
        submitBtn.disabled = false;
        clearScoreBtn.disabled = false;
        resetTimer();
    }

    async function submitAnswer() {
        const answer = parseInt(answerInput.value, 10);
        answerInput.value = '';
        if (isNaN(answer)) return;

        const res = await fetch('/api/math/answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...currentQuestion, answer })
        });

        const result = await res.json();
        total++;
        stopTimer();

        if (result.correct) {
            correct++;
            streak++;
            correctSound.play();
            document.getElementById('result').innerText = `‚úÖ Correct! (${timer}s)`;

            if (streak % 2 === 0) {
                incorrect = 0;
                const allTestsFinished = levelUp();
                if (allTestsFinished) return;
            }
        } else {
            incorrect++;
            streak = 0;
            incorrectSound.play();
            document.getElementById('result').innerText = `‚ùå Incorrect. The correct answer is ${result.expected} (${timer}s)`;

            if (incorrect >= 4) {
                levelDown();
                incorrect = 0;
            }
        }

        updateScoreboard();

        await getQuestion();
        await updateStudentSession();
    }

    function levelUp() {
        const currentIndex = levelOrder.indexOf(levelSelect.value);

        if (currentIndex < levelOrder.length - 1) {
            const nextLevel = levelOrder[currentIndex + 1];
            levelSelect.value = nextLevel;
            currentLevelEnum = nextLevel;
            document.getElementById('result').innerText += ` üéâ Level up to ${nextLevel}!`;
            levelUpSound.play();
            return false;
        } else {
            const testTypeKeys = Object.keys(testTypeMap);
            const currentTestIndex = testTypeKeys.indexOf(currentTestType);

            if (currentTestIndex < testTypeKeys.length - 1) {
                currentTestType = testTypeKeys[currentTestIndex + 1];
                currentLevelEnum = testTypeMap[currentTestType];
                levelSelect.value = currentLevelEnum;
                document.getElementById('result').innerText += ` üöÄ Moving to next test: ${currentTestType} (Level ${currentLevelEnum})`;
                levelUpSound.play();
                return false;
            } else {
                document.getElementById('result').innerText += ` üèÜ You finished all tests!`;
                levelUpSound.play();
                stopTimer();
                submitBtn.disabled = true;
                answerInput.disabled = true;
                currentQuestion = null;
                return true;
            }
        }
    }

    function levelDown() {
        const currentIndex = levelOrder.indexOf(levelSelect.value);
        if (currentIndex > 0) {
            const previousLevel = levelOrder[currentIndex - 1];
            levelSelect.value = previousLevel;
            currentLevelEnum = previousLevel;
            document.getElementById('result').innerText += ` ‚ö†Ô∏è Level down to ${previousLevel}`;
        } else {
            document.getElementById('result').innerText += ` ‚ö†Ô∏è Still at Level 1`;
        }
    }

    function updateScoreboard() {
        document.getElementById('score').innerText = `Score: ${correct} / ${total}`;
        document.getElementById('streak').innerText = `Streak: ${streak}`;
    }

    function clearScore() {
        total = 0;
        correct = 0;
        incorrect = 0;
        streak = 0;
        updateScoreboard();
    }

    function resetTimer() {
        stopTimer();
        timer = 0;
        document.getElementById('timer').innerText = `‚è±Ô∏è Time: ${timer}s`;
        timerInterval = setInterval(() => {
            timer++;
            document.getElementById('timer').innerText = `‚è±Ô∏è Time: ${timer}s`;
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
    }

    answerInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            submitAnswer();
        }
    });

    loadStudent();
</script>
</body>
</html>
